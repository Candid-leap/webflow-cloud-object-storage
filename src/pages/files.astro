---
import Layout from '../layouts/Layout.astro';
import { isAuthenticated } from '../utils/auth';

// Get the assets prefix from environment
const assetsPrefix = Astro.locals.runtime?.env?.ASSETS_PREFIX || '/app';
// Normalize base path (remove trailing slash if present, except for root)
const rawBasePath = import.meta.env.BASE_URL || '';
const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');
const env = Astro.locals.runtime?.env || {};

// Check authentication
const authenticated = await isAuthenticated(Astro.request, env);

if (!authenticated) {
	return Astro.redirect(`${basePath}/login`, 302);
}
---

<Layout title="File Uploader">
	<!-- Logout Button - Top Right -->
	<div style="position: fixed; top: 16px; right: 16px; z-index: 10000;">
		<button class="btn btn-outline btn-sm btn-error" id="logoutBtnTop">
			Logout
		</button>
	</div>
	
	<div class="container mx-auto p-6 max-w-6xl">
		<h1 class="text-4xl font-bold text-center mb-8">File Uploader</h1>
		
		<!-- Upload Section -->
		<div class="card bg-base-100 shadow-xl mb-8">
			<div class="card-body">
				<h2 class="card-title text-2xl mb-4">Upload Files</h2>
				<form id="uploadForm" class="space-y-4">
					<div class="form-control">
						<label class="label">
							<span class="label-text">Select Files</span>
						</label>
						<input 
							type="file" 
							id="fileInput" 
							multiple 
							class="file-input file-input-bordered w-full" 
							accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip,.rar"
						/>
					</div>
					
					<div class="form-control">
						<label class="label">
							<span class="label-text">Custom URL/Key (optional) <span id="replacingIndicator" class="text-primary hidden"></span></span>
						</label>
						<input 
							type="text" 
							id="customKeyInput"
							placeholder="e.g., my-document.pdf (leave empty for auto-generated name)"
							class="input input-bordered w-full"
						/>
						<label class="label">
							<span class="label-text-alt">Leave empty for auto-generated name, or specify a custom key to use the same URL. If a file with this key exists, it will be replaced.</span>
						</label>
						<div id="cancelReplaceBtn" class="hidden mt-2">
							<button type="button" class="btn btn-sm btn-ghost" onclick="
								document.getElementById('customKeyInput').value = '';
								document.getElementById('customKeyInput').disabled = false;
								document.getElementById('replacingIndicator').classList.add('hidden');
								document.getElementById('cancelReplaceBtn').classList.add('hidden');
								replacingKey = null;
							">
								Cancel Replace
							</button>
						</div>
					</div>
					
					<div class="form-control">
						<button type="submit" class="btn btn-primary" id="uploadBtn">
							<span class="loading loading-spinner loading-sm hidden" id="uploadSpinner"></span>
							Upload Files
						</button>
					</div>
				</form>
				
				<!-- Upload Progress -->
				<div id="uploadProgress" class="hidden mt-4">
					<div class="progress progress-primary w-full">
						<div class="progress-bar" id="progressBar" style="width: 0%"></div>
					</div>
					<p class="text-sm mt-2" id="progressText">Uploading...</p>
				</div>
			</div>
		</div>

		<!-- Files Section -->
		<div class="card bg-base-100 shadow-xl">
			<div class="card-body">
				<div class="flex justify-between items-center mb-4 flex-wrap gap-4">
					<h2 class="card-title text-2xl">Uploaded Files</h2>
					<div class="flex gap-2 items-center">
						<input 
							type="text" 
							id="searchInput"
							placeholder="Search files..." 
							class="input input-bordered input-sm w-48"
						/>
						<button class="btn btn-outline btn-sm" id="refreshBtn">
							<span class="loading loading-spinner loading-sm hidden" id="refreshSpinner"></span>
							Refresh
						</button>
					</div>
				</div>
				
				<div id="filesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
					<!-- Files will be loaded here -->
				</div>
				
				<div id="loadingFiles" class="text-center py-8">
					<span class="loading loading-spinner loading-lg"></span>
					<p class="mt-2">Loading files...</p>
				</div>
				
				<div id="noFiles" class="text-center py-8 hidden">
					<div class="text-6xl mb-4">üìÅ</div>
					<p class="text-lg">No files uploaded yet</p>
					<p class="text-sm text-base-content/70">Upload some files to get started</p>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	// Normalize base path for API calls
	const rawBasePath = import.meta.env.BASE_URL || '';
	const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');
	const assetsPrefix = '${assetsPrefix}';
	
	// DOM elements
	const uploadForm = document.getElementById('uploadForm') as HTMLFormElement;
	const fileInput = document.getElementById('fileInput') as HTMLInputElement;
	const customKeyInput = document.getElementById('customKeyInput') as HTMLInputElement;
	const uploadBtn = document.getElementById('uploadBtn') as HTMLButtonElement;
	const uploadSpinner = document.getElementById('uploadSpinner') as HTMLElement;
	const uploadProgress = document.getElementById('uploadProgress') as HTMLElement;
	const progressBar = document.getElementById('progressBar') as HTMLElement;
	const progressText = document.getElementById('progressText') as HTMLElement;
	const filesList = document.getElementById('filesList') as HTMLElement;
	const loadingFiles = document.getElementById('loadingFiles') as HTMLElement;
	const noFiles = document.getElementById('noFiles') as HTMLElement;
	const refreshBtn = document.getElementById('refreshBtn') as HTMLButtonElement;
	const refreshSpinner = document.getElementById('refreshSpinner') as HTMLElement;
	
	// State
	let replacingKey: string | null = null;
	let renamingKey: string | null = null;
	let newFileName: string = '';
	let searchQuery: string = '';

	// File type icons mapping
	const fileIcons: Record<string, string> = {
		'pdf': 'üìÑ',
		'doc': 'üìù',
		'docx': 'üìù',
		'txt': 'üìÑ',
		'zip': 'üì¶',
		'rar': 'üì¶',
		'video': 'üé•',
		'audio': 'üéµ',
		'default': 'üìé'
	};

	// Get file icon based on type
	function getFileIcon(filename: string): string {
		const ext = filename.split('.').pop()?.toLowerCase();
		if (ext && fileIcons[ext]) {
			return fileIcons[ext];
		}
		
		// Check if it's a video or audio file
		if (filename.match(/\.(mp4|avi|mov|wmv|flv|webm|mkv)$/i)) {
			return fileIcons.video;
		}
		if (filename.match(/\.(mp3|wav|flac|aac|ogg|wma)$/i)) {
			return fileIcons.audio;
		}
		
		return fileIcons.default;
	}

	// Format file size
	function formatFileSize(bytes: number): string {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	}

	// Format date
	function formatDate(dateString: string): string {
		return new Date(dateString).toLocaleDateString('en-US', {
			year: 'numeric',
			month: 'short',
			day: 'numeric',
			hour: '2-digit',
			minute: '2-digit'
		});
	}

	// Check if file is an image
	function isImage(filename: string): boolean {
		return filename.match(/\.(jpg|jpeg|png|gif|bmp|webp|svg)$/i) !== null;
	}

	// File interface
	interface FileItem {
		name?: string;
		key?: string;
		link?: string;
		dateUploaded?: string;
		uploaded?: string;
	}

	// Load and display files
	async function loadFiles() {
		try {
			loadingFiles.classList.remove('hidden');
			filesList.innerHTML = '';
			
			const apiPath = basePath ? `${basePath}/api/list-assets` : '/api/list-assets';
			const response = await fetch(apiPath);
			if (!response.ok) {
				throw new Error('Failed to load files');
			}
			
			const files = await response.json() as FileItem[];
			
			loadingFiles.classList.add('hidden');
			
			if (files.length === 0) {
				noFiles.classList.remove('hidden');
				return;
			}
			
			noFiles.classList.add('hidden');
			
			// Filter files based on search query
			const filteredFiles = files.filter((file: FileItem) => {
				if (!searchQuery.trim()) return true;
				const fileName = file.name || file.key || '';
				const fileKey = file.key || file.name || '';
				return fileName.toLowerCase().includes(searchQuery.toLowerCase()) ||
					   fileKey.toLowerCase().includes(searchQuery.toLowerCase());
			});
			
			if (filteredFiles.length === 0 && searchQuery.trim()) {
				filesList.innerHTML = `
					<div class="col-span-full text-center py-8">
						<div class="text-6xl mb-4">üîç</div>
						<p class="text-lg">No results found</p>
						<p class="text-sm text-base-content/70">Try a different search term</p>
					</div>
				`;
				return;
			}
			
			filteredFiles.forEach((file: FileItem) => {
				const fileName = file.name || file.key || 'Unknown file';
				const fileKey = file.key || file.name || '';
				const apiPath = basePath ? `${basePath}/api/asset` : '/api/asset';
				const fileLink = file.link || (fileKey ? `${apiPath}?key=${encodeURIComponent(fileKey)}` : '');
				const uploadDate = file.dateUploaded || file.uploaded || new Date().toISOString();
				
				const fileCard = document.createElement('div');
				fileCard.className = 'card bg-base-200 shadow-sm hover:shadow-md transition-shadow';
				
				const isImageFile = isImage(fileName);
				const cardId = `file-card-${fileKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
				fileCard.id = cardId;
				
				fileCard.innerHTML = `
					<figure class="px-4 pt-4">
						${isImageFile 
							? `<img src="${fileLink}" alt="${fileName}" class="rounded-xl h-32 w-full object-cover" />`
							: `<div class="flex items-center justify-center h-32 w-full bg-base-300 rounded-xl">
									<span class="text-4xl">${getFileIcon(fileName)}</span>
							   </div>`
						}
					</figure>
					<div class="card-body p-4">
						<div id="file-name-${cardId}" class="card-title text-sm truncate" title="${fileName}">${fileName}</div>
						<div id="rename-input-${cardId}" class="hidden">
							<input type="text" id="rename-text-${cardId}" value="${fileName}" class="input input-sm input-bordered w-full mb-2" />
							<div class="flex gap-2">
								<button class="btn btn-success btn-xs save-rename-btn" data-key="${fileKey}">Save</button>
								<button class="btn btn-ghost btn-xs cancel-rename-btn" data-key="${fileKey}">Cancel</button>
							</div>
						</div>
						<p class="text-xs text-base-content/70">${formatDate(uploadDate)}</p>
						<div class="card-actions justify-end mt-2 gap-2">
							<a href="${fileLink}" target="_blank" class="btn btn-primary btn-xs">
								View
							</a>
							<button class="btn btn-secondary btn-xs copy-url-btn" data-key="${fileKey}">
								Copy URL
							</button>
							<button class="btn btn-success btn-xs rename-btn" data-key="${fileKey}" data-name="${fileName}">
								Rename
							</button>
							<button class="btn btn-warning btn-xs replace-btn" data-key="${fileKey}">
								Replace
							</button>
							<button class="btn btn-error btn-xs delete-btn" data-key="${fileKey}" data-name="${fileName}">
								Delete
							</button>
						</div>
					</div>
				`;
				
				// Add event listener for replace button
				const replaceBtn = fileCard.querySelector('.replace-btn') as HTMLButtonElement;
				if (replaceBtn) {
					replaceBtn.addEventListener('click', () => {
						replacingKey = fileKey;
						customKeyInput.value = fileKey;
						customKeyInput.disabled = true;
						fileInput.value = '';
						const replacingIndicator = document.getElementById('replacingIndicator');
						const cancelReplaceBtn = document.getElementById('cancelReplaceBtn');
						if (replacingIndicator) {
							replacingIndicator.textContent = `(Replacing: ${fileKey})`;
							replacingIndicator.classList.remove('hidden');
						}
						if (cancelReplaceBtn) {
							cancelReplaceBtn.classList.remove('hidden');
						}
						// Scroll to upload section
						uploadForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
					});
				}
				
				// Add event listener for rename button
				const renameBtn = fileCard.querySelector('.rename-btn') as HTMLButtonElement;
				if (renameBtn) {
					renameBtn.addEventListener('click', () => {
						const nameDiv = fileCard.querySelector(`#file-name-${cardId}`) as HTMLElement;
						const renameDiv = fileCard.querySelector(`#rename-input-${cardId}`) as HTMLElement;
						const renameInput = fileCard.querySelector(`#rename-text-${cardId}`) as HTMLInputElement;
						if (nameDiv && renameDiv && renameInput) {
							nameDiv.classList.add('hidden');
							renameDiv.classList.remove('hidden');
							renameInput.focus();
							renameInput.select();
						}
					});
				}
				
				// Add event listener for save rename button
				const saveRenameBtn = fileCard.querySelector('.save-rename-btn') as HTMLButtonElement;
				if (saveRenameBtn) {
					saveRenameBtn.addEventListener('click', async () => {
						const renameInput = fileCard.querySelector(`#rename-text-${cardId}`) as HTMLInputElement;
						const newName = renameInput?.value.trim();
						if (!newName) {
							alert('Please enter a new file name');
							return;
						}
						
						try {
							const apiPath = basePath ? `${basePath}/api/rename-asset` : '/api/rename-asset';
							const response = await fetch(apiPath, {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({ oldKey: fileKey, newKey: newName })
							});
							
							if (!response.ok) {
								const error = await response.json();
								throw new Error(error.error || 'Failed to rename file');
							}
							
							alert('File renamed successfully!');
							loadFiles();
						} catch (error) {
							console.error('Rename failed:', error);
							alert(error instanceof Error ? error.message : 'Failed to rename file');
						}
					});
				}
				
				// Add event listener for cancel rename button
				const cancelRenameBtn = fileCard.querySelector('.cancel-rename-btn') as HTMLButtonElement;
				if (cancelRenameBtn) {
					cancelRenameBtn.addEventListener('click', () => {
						const nameDiv = fileCard.querySelector(`#file-name-${cardId}`) as HTMLElement;
						const renameDiv = fileCard.querySelector(`#rename-input-${cardId}`) as HTMLElement;
						if (nameDiv && renameDiv) {
							nameDiv.classList.remove('hidden');
							renameDiv.classList.add('hidden');
						}
					});
				}
				
				// Add event listener for delete button
				const deleteBtn = fileCard.querySelector('.delete-btn') as HTMLButtonElement;
				if (deleteBtn) {
					deleteBtn.addEventListener('click', async () => {
						if (!confirm(`Are you sure you want to delete "${fileName}"?`)) {
							return;
						}
						
						try {
							const apiPath = basePath ? `${basePath}/api/delete-asset?key=${encodeURIComponent(fileKey)}` : `/api/delete-asset?key=${encodeURIComponent(fileKey)}`;
							const response = await fetch(apiPath, {
								method: 'DELETE'
							});
							
							if (!response.ok) {
								throw new Error('Failed to delete file');
							}
							
							alert('File deleted successfully!');
							loadFiles();
						} catch (error) {
							console.error('Delete failed:', error);
							alert('Failed to delete file. Please try again.');
						}
					});
				}
				
				// Handle Enter key in rename input
				const renameInput = fileCard.querySelector(`#rename-text-${cardId}`) as HTMLInputElement;
				if (renameInput) {
					renameInput.addEventListener('keydown', (e) => {
						if (e.key === 'Enter') {
							saveRenameBtn?.click();
						} else if (e.key === 'Escape') {
							cancelRenameBtn?.click();
						}
					});
				}
				
				// Add event listener for copy URL button
				const copyUrlBtn = fileCard.querySelector('.copy-url-btn') as HTMLButtonElement;
				if (copyUrlBtn) {
					copyUrlBtn.addEventListener('click', async () => {
						try {
							// Get current hostname and path
							const currentOrigin = window.location.origin;
							const basePath = assetsPrefix || '';
							const apiPath = basePath ? `${basePath}/api/asset` : '/api/asset';
							const fullUrl = `${currentOrigin}${apiPath}?key=${encodeURIComponent(fileKey)}`;
							
							await navigator.clipboard.writeText(fullUrl);
							
							// Show toast
							showToast('URL copied to clipboard!');
						} catch (error) {
							console.error('Failed to copy URL:', error);
							showToast('Failed to copy URL');
						}
					});
				}
				
				filesList.appendChild(fileCard);
			});
		} catch (error) {
			console.error('Error loading files:', error);
			loadingFiles.classList.add('hidden');
			filesList.innerHTML = `
				<div class="col-span-full text-center py-8">
					<div class="text-6xl mb-4">‚ùå</div>
					<p class="text-lg text-error">Failed to load files</p>
					<p class="text-sm text-base-content/70">Please try again later</p>
				</div>
			`;
		}
	}

	// Handle file upload
	async function handleUpload(event: Event) {
		event.preventDefault();
		
		const files = fileInput.files;
		if (!files || files.length === 0) {
			alert('Please select files to upload');
			return;
		}
		
		// Show loading state
		uploadBtn.disabled = true;
		uploadSpinner.classList.remove('hidden');
		uploadProgress.classList.remove('hidden');
		
		try {
			for (let i = 0; i < files.length; i++) {
				const file = files[i];
				const formData = new FormData();
				formData.append('file', file);
				
				// Add custom key if provided (use the same key for all files if replacing, or individual keys)
				const customKey = customKeyInput.value.trim();
				if (customKey) {
					// If replacing, use the same key; otherwise, append index for multiple files
					const keyToUse = replacingKey || (files.length > 1 ? `${customKey}-${i}` : customKey);
					formData.append('key', keyToUse);
				}
				
				// Update progress
				const progress = ((i + 1) / files.length) * 100;
				progressBar.style.width = `${progress}%`;
				progressText.textContent = replacingKey 
					? `Replacing file with key: ${replacingKey}...`
					: `Uploading ${file.name}...`;
				
				const apiPath = basePath ? `${basePath}/api/upload` : '/api/upload';
				const response = await fetch(apiPath, {
					method: 'POST',
					body: formData
				});
				
				if (!response.ok) {
					throw new Error(`Failed to upload ${file.name}`);
				}
			}
			
			// Success
			progressText.textContent = replacingKey ? 'File replaced successfully!' : 'Upload completed!';
			progressBar.style.width = '100%';
			
			// Reset form
			fileInput.value = '';
			customKeyInput.value = '';
			customKeyInput.disabled = false;
			replacingKey = null;
			const replacingIndicator = document.getElementById('replacingIndicator');
			const cancelReplaceBtn = document.getElementById('cancelReplaceBtn');
			if (replacingIndicator) {
				replacingIndicator.textContent = '';
				replacingIndicator.classList.add('hidden');
			}
			if (cancelReplaceBtn) {
				cancelReplaceBtn.classList.add('hidden');
			}
			
			// Reload files list
			setTimeout(() => {
				loadFiles();
				uploadProgress.classList.add('hidden');
			}, 1000);
			
		} catch (error) {
			console.error('Upload error:', error);
			progressText.textContent = 'Upload failed!';
			alert('Upload failed: ' + (error instanceof Error ? error.message : 'Unknown error'));
		} finally {
			// Reset loading state
			uploadBtn.disabled = false;
			uploadSpinner.classList.add('hidden');
		}
	}

	// Search input
	const searchInput = document.getElementById('searchInput') as HTMLInputElement;
	if (searchInput) {
		searchInput.addEventListener('input', () => {
			searchQuery = searchInput.value;
			loadFiles();
		});
	}

	// Logout function - call logout endpoint and redirect
	async function handleLogout() {
		try {
			// Get base path for API call and redirect
			const rawBasePath = import.meta.env.BASE_URL || '';
			const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');
			const logoutPath = basePath ? `${basePath}/api/auth/logout` : '/api/auth/logout';
			
			// Call logout endpoint to clear httpOnly cookie
			// Use credentials: 'include' to ensure cookies are sent
			const response = await fetch(logoutPath, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json',
				},
			});
			
			// Wait for the response to ensure cookie is cleared
			if (response.ok) {
				// Cookie is now cleared, redirect to login
				const loginPath = basePath ? `${basePath}/login` : '/login';
				window.location.href = loginPath;
			} else {
				console.error('Logout failed:', response.status, response.statusText);
				// Even if logout fails, redirect to login (auth check will handle it)
				const loginPath = basePath ? `${basePath}/login` : '/login';
				window.location.href = loginPath;
			}
		} catch (error) {
			console.error('Logout error:', error);
			// Fallback: redirect to login (auth check will handle it)
			const rawBasePath = import.meta.env.BASE_URL || '';
			const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');
			const loginPath = basePath ? `${basePath}/login` : '/login';
			window.location.href = loginPath;
		}
	}

	// Event listeners
	uploadForm.addEventListener('submit', handleUpload);
	refreshBtn.addEventListener('click', () => {
		refreshSpinner.classList.remove('hidden');
		loadFiles().finally(() => {
			refreshSpinner.classList.add('hidden');
		});
	});
	

	// Toast notification function
	function showToast(message: string) {
		// Remove existing toast if any
		const existingToast = document.getElementById('toast-notification');
		if (existingToast) {
			existingToast.remove();
		}
		
		// Create toast element
		const toast = document.createElement('div');
		toast.id = 'toast-notification';
		toast.className = 'fixed bottom-4 right-4 bg-success text-white px-6 py-3 rounded-lg shadow-lg z-50 flex items-center gap-2 animate-slide-in';
		toast.innerHTML = `
			<span class="text-xl">‚úì</span>
			<span>${message}</span>
		`;
		
		document.body.appendChild(toast);
		
		// Remove toast after 3 seconds
		setTimeout(() => {
			toast.style.animation = 'slide-out 0.3s ease';
			setTimeout(() => {
				toast.remove();
			}, 300);
		}, 3000);
	}

	// Load files on page load
	loadFiles();
</script>

<style>
	@keyframes slide-in {
		from {
			transform: translateX(100%);
			opacity: 0;
		}
		to {
			transform: translateX(0);
			opacity: 1;
		}
	}
	
	@keyframes slide-out {
		from {
			transform: translateX(0);
			opacity: 1;
		}
		to {
			transform: translateX(100%);
			opacity: 0;
		}
	}
</style>
