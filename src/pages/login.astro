---
import Layout from '../layouts/Layout.astro';
import { isAuthenticated } from '../utils/auth';

const env = Astro.locals.runtime?.env || {};
// Normalize base path (remove trailing slash if present, except for root)
const rawBasePath = import.meta.env.BASE_URL || '';
const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');

// Check if user is already authenticated - if so, redirect to app
const authenticated = await isAuthenticated(Astro.request, env);

if (authenticated) {
	// Redirect to base URL (app root) - remove /login path
	return Astro.redirect(basePath || '/', 302);
}
---

<Layout title="Login">
	<div class="min-h-screen flex items-center justify-center bg-base-200 p-6">
		<div class="w-full max-w-md mx-auto">
			<div class="card bg-base-100 shadow-2xl">
				<div class="card-body p-8">
					<!-- Title Section -->
					<div class="flex flex-col items-center justify-center text-center mb-8">
						<h1 class="text-4xl font-bold mb-8 text-center">Apex File Uploader</h1>
					</div>

					<!-- Simple Divider -->
					<div class="border-t border-base-300 my-8"></div>

					<!-- Login Button -->
					<div class="flex justify-center mb-6">
						<button 
							id="loginBtn" 
							class="login-button"
							style="
								padding: 14px 24px;
								background-color: #146ef5 !important;
								color: white !important;
								border: none !important;
								border-radius: 8px;
								cursor: pointer;
								font-size: 16px;
								font-weight: 600;
								transition: all 0.3s ease;
								box-shadow: 0 2px 4px rgba(20, 110, 245, 0.2);
								transform: translateY(0);
								width: 100%;
								max-width: 300px;
								display: flex !important;
								align-items: center;
								justify-content: center;
								gap: 8px;
								opacity: 1 !important;
								visibility: visible !important;
							"
							onmouseenter="
								if (!this.disabled) {
									this.style.backgroundColor = '#2c80fd';
									this.style.transform = 'translateY(-2px)';
									this.style.boxShadow = '0 4px 8px rgba(20, 110, 245, 0.3)';
								}
							"
							onmouseleave="
								if (!this.disabled) {
									this.style.backgroundColor = '#146ef5';
									this.style.transform = 'translateY(0)';
									this.style.boxShadow = '0 2px 4px rgba(20, 110, 245, 0.2)';
								}
							"
						>
							<svg xmlns="http://www.w3.org/2000/svg" style="height: 20px; width: 20px; color: white !important; stroke: white !important;" fill="none" viewBox="0 0 24 24" stroke="currentColor">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
							</svg>
							<span id="loginBtnText" style="color: white !important;">Login with Webflow</span>
							<span class="loading loading-spinner loading-sm hidden" id="loginSpinner"></span>
						</button>
					</div>

					<!-- Info Section -->
					<div class="mt-8 pt-6 border-t border-base-300">
						<div class="alert alert-info flex items-start">
							<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
							</svg>
							<div class="text-sm text-center flex-1">
								<p class="font-semibold text-center">Secure Authentication</p>
								<p class="text-xs mt-1 text-center">Your credentials are securely handled by Webflow OAuth</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>

<script>
	// Get base path - normalize it (remove trailing slash if present, except for root)
	const rawBasePath = import.meta.env.BASE_URL || '';
	const basePath = rawBasePath === '/' ? '' : rawBasePath.replace(/\/$/, '');
	const loginBtn = document.getElementById('loginBtn');
	const loginBtnText = document.getElementById('loginBtnText');
	const loginSpinner = document.getElementById('loginSpinner');
	
	if (loginBtn) {
		loginBtn.addEventListener('click', async () => {
			try {
				// Show loading state
				loginBtn.disabled = true;
				loginBtn.style.backgroundColor = '#ccc';
				loginBtn.style.cursor = 'not-allowed';
				if (loginBtnText) loginBtnText.textContent = 'Connecting...';
				if (loginSpinner) loginSpinner.classList.remove('hidden');
				
				// Get the Webflow auth URL - ensure we have a proper path
				const apiUrl = basePath ? `${basePath}/api/auth/webflow-url` : '/api/auth/webflow-url';
				console.log('Fetching auth URL from:', apiUrl);
				
				const response = await fetch(apiUrl, {
					headers: {
						'Accept': 'application/json',
					},
				});
				
				console.log('Response status:', response.status, response.statusText);
				console.log('Response content-type:', response.headers.get('content-type'));
				
				// Check if response is OK before parsing JSON
				if (!response.ok) {
					// Try to parse error message, but handle HTML responses
					let errorMessage = 'Failed to get auth URL';
					const contentType = response.headers.get('content-type') || '';
					
					if (contentType.includes('application/json')) {
						try {
							const errorData = await response.json();
							errorMessage = errorData.error || errorMessage;
						} catch (e) {
							console.error('Failed to parse error JSON:', e);
							errorMessage = `HTTP ${response.status}: ${response.statusText}`;
						}
					} else {
						// Response is HTML (likely an error page)
						const text = await response.text();
						console.error('Received HTML instead of JSON:', text.substring(0, 200));
						errorMessage = `HTTP ${response.status}: Server returned HTML instead of JSON. Check that the API route exists and environment variables are set.`;
					}
					throw new Error(errorMessage);
				}
				
				// Parse JSON only if response is OK
				const data = await response.json();
				console.log('Received data:', data);
				
				if (!data.authUrl) {
					throw new Error('Auth URL not found in response');
				}
				
				// Redirect to Webflow OAuth
				window.location.href = data.authUrl;
			} catch (error) {
				console.error('Login error:', error);
				
				// Reset button state
				loginBtn.disabled = false;
				loginBtn.style.backgroundColor = '#146ef5';
				loginBtn.style.cursor = 'pointer';
				if (loginBtnText) loginBtnText.textContent = 'Login with Webflow';
				if (loginSpinner) loginSpinner.classList.add('hidden');
				
				// Show error alert with detailed message
				const errorMessage = error instanceof Error ? error.message : 'Failed to initiate login. Please try again.';
				alert(`Login Error: ${errorMessage}\n\nPlease check that WEBFLOW_CLIENT_ID and WEBFLOW_REDIRECT_URI environment variables are set.`);
			}
		});
	}
</script>

<style>
	#loginBtn,
	.login-button {
		background-color: #146ef5 !important;
		color: white !important;
		opacity: 1 !important;
		visibility: visible !important;
		display: flex !important;
	}
	
	#loginBtn svg,
	.login-button svg {
		color: white !important;
		stroke: white !important;
	}
	
	#loginBtn #loginBtnText,
	.login-button #loginBtnText {
		color: white !important;
	}
</style>

